$(document).ready(function () {
	
	let isPreviewMode = $('#wcmMode').val() == 'true' ? false : true;
	if(isPreviewMode){
       $('#user-registration').css('display', 'none');
    }


	//logout modal changes
	let login_link = $('.login-link a').attr('href');
	$('.logout-link').find('.a-link__text').attr('href', 'javascript:void(0);')
	setTimeout(function () {
		let id = $('.logout-link').find('div').attr('data-target');
		$(id).addClass('rp').addClass('alg-center');
		$(id).find('.modal-footer .button:first-child a').addClass('confirm-logout');
	}, 1000);

	$(document).on('click', '.confirm-logout', function (event) {
		deleteCookie('jwtToken');
		localStorage.removeItem("dynamicEmail");
		$('.logout-link, .my-acc').addClass('display-hidden');
		$('.login-link').removeClass('display-hidden');
	});


	let login_Html = $('.o-header__secondary-top-nav .login-container').html();
	let logout_Html = $('.o-header__secondary-top-nav .logout-container').html();

	let browserUrlPath = window.location.pathname.toLowerCase();
	
	let loginRedirectionEnabled = false;
	if(browserUrlPath && browserUrlPath.indexOf('/au/en/') > -1){
		loginRedirectionEnabled = true;
		sessionStorage.setItem('documentReferrer',document.referrer);
	}
	
	// check coookie
	let jwtToken = getCookie("jwtToken");
	let wcmmodeChk = getCookie("cq-authoring-mode");

	function checkLoginLink() {
		if ($('.o-header__mob-options').children().hasClass('login-link')) {
			$('.o-header__mob-options').addClass('rp');
			$('.m-mega-menu__mobile button.navbar-toggler').hide();
		}
	}

	function hiddenPublicPage() {
		if (!$('.hidden input[name="publicPage"]').length && !wcmmodeChk && loginRedirectionEnabled && login_link) {
			window.location.href = login_link;
		}
	}

	function getDynamicEmailVal() {
		let dynamicEmailInput = $('input[name="dynamicEmail"]');
		if (dynamicEmailInput.length) {
			dynamicEmailInput.val(localStorage.getItem('dynamicEmail'));
		}
	}

	if (jwtToken == "" || jwtToken == typeof undefined) {
		$('.o-header__mob-options').html(login_Html);
		localStorage.removeItem("dynamicEmail");
		checkLoginLink();
		hiddenPublicPage();
		$('.logout-link, .my-acc').addClass('display-hidden');
		$('.o-header__mega-menu').hide();
	} else {
		$('.login-link').addClass('display-hidden');
		$('.o-header__mega-menu').show();
		$('.o-header__mob-options').html(logout_Html);
		getDynamicEmailVal();
	}
	
	//mega menu active links border code 
	let win_url = window.location.href.slice(window.location.href.lastIndexOf("/") + 1).split("?")[0];
	$('.o-header-v2-global__section .m-mega-menu__mobile .navbar-nav .m-mega-menu__mobile-item-wrapper .a-link__text').each(function(){
		let href = $(this).attr('href');
		let cv_mint = $(this).closest(".section.cv_mint");
		if (href.indexOf(win_url) > -1 && href.indexOf("#") === -1 && !cv_mint.length) {
			$(this).closest("li").addClass('active');
		}			
	});

	$('.o-header-v2-global__section .navbar-nav .m-mega-menu__mobile-item-wrapper .nav-link').each(function(){
		let url = $(this).attr('href');
		let cv_mint = $(this).closest(".section.cv_mint");
		if (url.indexOf(win_url) > -1 && !cv_mint.length) {
			$(this).closest("li").addClass('active');
		}			
	});

	$('.o-header__mega-menu').parents('.o-header-v2-global__section--utility-bottom').addClass('o-header__mega-menu');

	$(document).on('click', '.logout-link', function () {
		$("#logout").parents().find('.modal-footer').addClass('logout-footer');
	});

	//mega menu href fix for mobile/ipad screens
	if (window.innerWidth < 992) {  
		$('.m-mega-menu__mobile .navbar-nav .m-mega-menu__mobile-item-wrapper .navigation .m-mega-menu__item .nav-item').each(function(){
			let href = $(this).attr('href');
			let navItemTxt = $(this).text();
			let addEle = "<a class='mob-nav-link'></a>";
			let curEle = $(this).parent().parent().find('.m-mega-menu__mobile-item').children('.m-mega-menu__mobile-header');
			$(this).parent().parent().find('.m-mega-menu__mobile-item').children('.m-mega-menu__mobile-header').attr('href','javascript:void(0)');
			$(this).parent().parent().find('.m-mega-menu__mobile-item').children('.m-mega-menu__mobile-header').prepend(addEle);
			$(this).parent().parent().find('.m-mega-menu__mobile-item').children('.m-mega-menu__mobile-header').find('.mob-nav-link').text(navItemTxt);
			$(this).parent().parent().find('.m-mega-menu__mobile-item').children('.m-mega-menu__mobile-header').find('.mob-nav-link').attr('href',href);
			curEle.contents().filter(function () {
				return this.nodeType === 3; 
			}).remove();
		});
	}
	
	$('.o-form-container .options').each(function(){
		let mandval = $(this).find('label>span.a-dropdown__title--required');
		if (mandval.text() == '*') {
			mandval.parent().addClass('hidden');
		}
	});
	
	$('.o-form-container[data-js-component="formcontainer"] .o-form-container__buttons .button>button.btn').on('click', function(){
		let elem = $(this).parents('.o-form-container__buttons');
			elem.siblings().eq(elem.index()+1).addClass('active');
    });
	

	//Adding INT flags in language navigator
	let path = location.pathname.toLowerCase();
    if (path.indexOf("/int/en/") >= 0){
		addAndRemoveFlag('flag-icon flag-icon-int');
	}

    function addAndRemoveFlag(flagClsName){
	    let $span = $( ".m-link-stack--dropdown .m-link-stack__link .a-link__text" ).find( "span.flag-icon" );
        $span.removeClass();
        $span.addClass(flagClsName);
    }
	//Language Nvigation on mobile/ipad
	let isMobile = window.matchMedia("(max-width: 991.98px)").matches;

	if (isMobile) {
		//Utility nav links into hamburgermenu code
		$('.o-header__utility-nav').children().each(function(){
			let curEle = $(this).attr('class');
			if (curEle.match('a-link')){
				$(".m-mega-menu__mobile ul").append('<li class="m-mega-menu__mobile-item-wrapper bt"><div class="link button"></div></li>');
				$(".m-mega-menu__mobile ul li:last-child>div").append($(this).clone());
			}else {
				$(".m-mega-menu__mobile ul").append('<li class="m-mega-menu__mobile-item-wrapper bt"></li>');
				$(".m-mega-menu__mobile ul li:last-child").append($(this).clone());
			}
			$(".login-container, .logout-container").parents('li').remove();	
		});
	}

	$('.a-dropdown__field>.a-dropdown__placeholder').each(function(){
		if ($(this).height() > "25") {
			$(this).addClass('dyn-height');
		}
	});

	let panZoomSection = $(".a-pan-zoom");
	if (panZoomSection.length > 0) {
		panZoomSection.parents(".a-container").css("z-index","1");
	}
});

function loadSpinnerIcon() {
	let spinnerIcon = setTimeout(loadSpinnerIcon, 1000);
	if ($("button#resetpassword").parents('.o-form-container__main-form').siblings('.o-form-container__success-msg').text().length == '0') {
		$("button#resetpassword").parent().addClass('a-button--spinner');
	} else {
		$("button#resetpassword").parent().removeClass('a-button--spinner');
		clearTimeout(spinnerIcon);
	}
}

$('.o-form-container[data-js-component="formcontainer"] .form-container .button>button#resetpassword').on('click', function() {
	loadSpinnerIcon();
});



// Scroll to specific section if anchor id in URL 

$(window).on('load', function() {

	let headerHeight = $(".o-header-v2-global__sticky-section").height();
	
	function hashUrlScroll (){
		let urlVal = window.location.href;
		let hashUrlVal = urlVal.split("#")[1];
		if (urlVal.indexOf("#") > -1) {
			let sec_id = $("#"+hashUrlVal).val();
			if(typeof sec_id != "undefined") {
				let scrollTo =  $("#"+hashUrlVal).offset().top;
				$('html, body').animate({scrollTop: scrollTo - headerHeight*2+25}, 'slow');
			}
		}
	}

	hashUrlScroll();

	//TrustArc banner ISI Overlap
	let consentBannerSection = $("#consent-banner");
	function stickWithConsentBanner() {
		let heightConsentBanner = $('.trustarc-banner-wrapper').height();
		$('<style>.a-floatingactionbutton { bottom: ' + heightConsentBanner + 'px !important };</style>').appendTo('head');
	}
	if (consentBannerSection.length > 0) {
		stickWithConsentBanner();
	}

	// CVNMAEM-4494
	setTimeout(function(){
		let floatingFeedbackSection = $("div._acsmiddleright._acsVertical_right._acsbadge--default");
		function stickFeedbackButton(){
			if($(window).height() < 715) {
				$('div._acsmiddleright._acsVertical_right._acsbadge--default').addClass('sticktobottom');
			}
		}
		if (floatingFeedbackSection.length > 0) {
			stickFeedbackButton();
		}
	}, 100);
});

$(document).ready(function () {
	const countryLangNav = $('input[name="country-lang-nav"]');
	if (countryLangNav.length) {
		const countryLangNavValue = countryLangNav.attr("value");
		$(".languagenavigation .m-link-stack__list-item a").each((_, element) => {
			const hrefLang = $(element).attr("href").split('/');
			if (hrefLang.length > 3) {
				$(element).attr("href", [...hrefLang.slice(0, 3), countryLangNavValue].join('/'));
			}
		});
	}

	// anchor links
	$('a[href^="#"]').on('click', function() {
		if($(this).is('[href^="#"')){
			let sec_id = $(this).attr('href')
			let scrollTo = $(sec_id).offset().top;
		$('html, body').animate({scrollTop: scrollTo-120}, 'slow');
		}
	});
});
function getCVDisclaimerCookie(cname) {
    let name = cname + "=";
    let ca = document.cookie.split(';');
    let foundCookie = ca.find(cookie => {
        let c = cookie.trim();
        return c.indexOf(name) === 0;
    });
    return foundCookie ? foundCookie.substring(name.length, foundCookie.length) : "";
}

function setCVDisclaimerCookie(cname, cvalue, exdays) {
        let d = new Date();
        d.setTime(d.getTime() + (exdays*24*60*60*1000));
        let expires = "expires=" + d.toGMTString();
        document.cookie = cname + "=" + cvalue + ";"+expires+";path=/";
}
function getTenderDiscUrlParam(name) {
  return (location.search.split(name + '=')[1] || '').split('&')[0];
}

function displaySiteSectionDisclaimer() {

	let country = document.getElementsByName("x-country-code")[0]?.value?.toLowerCase();
	let siteSectionPopupHCPCV = $("#site-section-popup-content");

	if(siteSectionPopupHCPCV.length > 0 && country){
		let cvIntDiscCookieName = "AbbottCardioVaScuLarHCPDisC"+"-"+"cv"+"-"+country;
		let cvIntDisc = getCVDisclaimerCookie(cvIntDiscCookieName);

		let isEditMode = $("#site-section-popup-content").data("wcm-edit-mode");

		if(cvIntDisc == '' && !isEditMode){
			$("#site-section-popup-content").css("display", "block");
			$("#section_disclaimer_confirm_btn").on('click', function(event){

				setCVDisclaimerCookie(cvIntDiscCookieName, 'Yes', 1);
				$("#site-section-popup-content").css("display", "none");
			});
		}
	}
}
function displayTenderProductImageDisclaimer() {
	
	let tenderProductDisclaimerElement= $("#tender-product-disclaimer-item");
	if(tenderProductDisclaimerElement.length >0){
		let disclaimerPlaceholder= $("#tender-product-disclaimer-palceholder");
		if(tenderProductDisclaimerElement && disclaimerPlaceholder){
			disclaimerPlaceholder.replaceWith(tenderProductDisclaimerElement);
			$("#tender-product-disclaimer-content").css("display", "block");
		}
		
		$("#tender-product-disclaimer-content #acceptLinkId").on('click', function(event){
            let date = new Date();
            date.setTime(date.getTime()+(5*1000));
            let disclaimerUrl="";
    
            let tenderImgUrl = getTenderDiscUrlParam('tenderUrl');
            
            if (tenderImgUrl) {
    
                disclaimerUrl = document.location.origin + "/content/dam/cv/cardiovascular/tender-product-images/" + tenderImgUrl;
    
                document.cookie = "AbbottTenderImages="+tenderImgUrl+"; path=/;expires="+date.toGMTString();
                $('#tender-product-disclaimer-content #acceptLinkId').attr("download", "")
                $('#tender-product-disclaimer-content #acceptLinkId').attr("href",disclaimerUrl);
    			$('#tender-product-disclaimer-content').css("display", "none");
            }
        });
	}
}
$(document).ready(function () {
	let country = document.getElementsByName("x-country-code")[0]?.value?.toUpperCase();
	if(($('#site-entering-popup-content[data-site-entering-popup-required="true"]').length > 0 && (localStorage.getItem('alreadyVisited')?.indexOf(country) >= 0 && localStorage.getItem('alreadyVisited') != null)) || $('#site-entering-popup-content[data-site-entering-popup-required="false"]').length > 0){
		displaySiteSectionDisclaimer();
	}

	setTimeout(function () {
		 $("#site_disclaimer_confirm_btn").on('click', function(){
		 	displaySiteSectionDisclaimer();
	 	});
	}, 1500);
	displayTenderProductImageDisclaimer();		
});