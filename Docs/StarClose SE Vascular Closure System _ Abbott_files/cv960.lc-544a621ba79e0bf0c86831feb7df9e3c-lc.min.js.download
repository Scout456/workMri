$(document).ready(function() {
    $(".footer .m-link-stack--header .abt-icon-down-arrow").on( "click", function() {
    $(this).toggleClass("abt-icon-down-arrow abt-icon-up-arrow");
    });
});
$(document).ready(function() {
    $(".header .languagenavigation .m-link-stack__link, .header .languagenavigation .abt-icon").click(function(){
        $(".header .languagenavigation .m-link-stack .abt-icon").toggleClass("rotate-upside");
    });
    let lists=$(".richtext .cmp-text ol li,.richtext .cmp-text ul li");
    lists.each(function () {
        if($(this).find('span:last-child').length > 0){
            $(this).addClass($(this).find('span:last').attr('class'))
            $(this).attr('style',$(this).find('span:last').attr('style'))
        }
    });
    $(".o-footer__social-media .m-social-media--icons li a").click(function(){
        window.open($(this).attr('href'),$(this).attr('target'));
    });
    let headermenu=$(".header .o-header-v2-global .navbar-collapse-wrapper .m-mega-menu__mobile-item-wrapper .navigation .m-mega-menu__mobile-item");
    headermenu.each(function(){
        if($(this).find('.m-mega-menu__mobile-item').length == 0){
            $(this).find('.m-mega-menu__mobile-header').addClass("arrowhide");
        }
    });
    $(document).on('click', function(event) {
        if ($(event.target).parent().attr('data-redirect-confirm') == 'true' || $(event.target).attr('data-redirect-confirm') == 'true') {
            if ($('#siteLeavingPopupFragmentPathModal')) {
                $('#siteLeavingPopupFragmentPathModal').css('display', 'block');
                $('.modal-backdrop').css('display', 'block');
                $('body').css({
                    'overflow-y': 'hidden',
                    'padding-right': '17px'
                });
            }
            setTimeout(() => {
                if ($('#siteLeavingPopupFragmentPathModal .button')) {
                    $(document).on('click', '#siteLeavingPopupFragmentPathModal .button', function() {
                        let getAttrVal = $('#siteLeavingPopupFragmentPathModal .button > div').attr('data-btn-type');
                        if (getAttrVal && getAttrVal == 'continue') {
                            $('#siteLeavingPopupFragmentPathModal').css('display', 'none');
                            $('.modal-backdrop').css('display', 'none');
                            $('body').css({
                                'overflow-y': 'scroll',
                                'padding-right': '0'
                            });
                        }
                    });
                }
            }, 100);
        }
    })

});
let crmViewItemList = document.querySelector('.o-search-res__results--view');

if (crmViewItemList) {
    let observer = new MutationObserver(() => {
        crmCardViewURL();
        crmListViewURL();
        crmTitleURLOnCard();
    });

    observer.observe(crmViewItemList, {
        childList: true
    });
}


function crmCardViewURL() {
    $(".a-card-result.a-card-result__cardrow").each(function () {
        let articleCardURLVal = $(this).find('.m-search-results__card-item-detail-articleurl .articleurl').text().trim();
        $(this).find('.m-search-results__card-item-detail-url a').attr('href', articleCardURLVal);
        if (articleCardURLVal.match("^/content")) {
            $(this).find('.m-search-results__card-item-detail-url a').attr('href', articleCardURLVal + '.html')
        }
    });
}

function crmListViewURL() {
    $(".a-list-result.a-list-result__listview").each(function () {
        let articleListURLVal = $(this).find('.m-search-results__list-item-detail-articleurl .articleurl').text().trim();
        $(this).find('.m-search-results__list-item-detail-url a').attr('href', articleListURLVal);
        if (articleListURLVal.match("^/content")) {
            $(this).find('.m-search-results__list-item-detail-url a').attr('href', articleListURLVal + '.html')
        }
    });
}

function crmTitleURLOnCard() {
    $(".a-card-result.a-card-result__cardrow").on( "click", function() {
        let urlValue = $(this).find(".m-search-results__card-item-detail-url a").attr("href");
        window.open(urlValue, '_blank')
        return false;
   });
}
$(document).ready(() => {
    $('[id^="tooltip-"]').hover(
        (event) => {
            $(event.currentTarget).removeAttr("href");
            const id = $(event.currentTarget).attr('id');
            $(`#${id.replace('tooltip', 'tooltip-content')}`).show();
            let position = $(event.currentTarget).position();
            let height = $(event.currentTarget).outerHeight();
            $(`#${id.replace('tooltip', 'tooltip-content')}`).parent().css({
                position: 'absolute',
                top: position.top + height + 10 + 'px',
                left: position.left - 40 + 'px'
            });
        },
        (event) => {
            const id = $(event.currentTarget).attr('id');
            $(`#${id.replace('tooltip', 'tooltip-content')}`).hide();
        }
    );
});


let jsonData = {};

async function loadJSONData() {
    const urls = [
        '/etc.clientlibs/cv/division/clientlibs/clientlib-themes/resources/json/bmi_bnp_ef_gr_40.json',
        '/etc.clientlibs/cv/division/clientlibs/clientlib-themes/resources/json/bmi_bnp_ef_lte_40.json',
        '/etc.clientlibs/cv/division/clientlibs/clientlib-themes/resources/json/bmi_ntprobnp_ef_lte_40.json',
        '/etc.clientlibs/cv/division/clientlibs/clientlib-themes/resources/json/bmi_ntprobnp_ef_gr_40.json'
    ];
    try {
        const dataPromises = urls.map(url => fetch(url).then(res => res.json()));
        const dataResults = await Promise.all(dataPromises);

        jsonData.bmi_bnp_ef_gr_40 = dataResults[0];
        jsonData.bmi_bnp_ef_lte_40 = dataResults[1];
        jsonData.bmi_ntprobnp_ef_lte_40 = dataResults[2];
        jsonData.bmi_ntprobnp_ef_gr_40 = dataResults[3];
    } catch (error) {
        console.error('Error loading JSON data:', error.message);
    }
}

document.addEventListener('DOMContentLoaded', () => {
    loadJSONData();
});

const openModal = (modalId) => {
    $(`#${modalId}`).parent().click();
};

const setStepDisabled = (stepName, isDisabled) => {
    $(`.o-wizard__btn button[name="${stepName}"]`).prop('disabled', isDisabled);
};

const handleNyhaClassChange = (value) => {
    if (value === 'classOne' || value === 'classFour') {
        openModal('modal-non-indic-nyha');
        setStepDisabled('step2', true);
    } else {
        setStepDisabled('step2', false);
    }
}

$('input[name="nyhaClass"]').change(function () {
    handleNyhaClassChange($(this).val());
});

const handlehfHospitalizationChange = (value) => {
    if (value === 'yes') {
        openModal('modal-indic');
        setStepDisabled('step3', true);
    } else {
        setStepDisabled('step3', false);
    }
}

$('input[name="hfHospitalization"]').change(function () {
    handlehfHospitalizationChange($(this).val());
});

const toggleSections = (showSection, hideSection) => {
    $(showSection).show();
    $(hideSection).hide();
};

function toggleInputBasedOnSelection(selector, inputSelector, value) {
    if ($(selector + ' input[name="ntprobnp"][value="' + value + '"]:checked').val()) {
        $(inputSelector).prop('disabled', false);
    } else {
        $(inputSelector).prop('disabled', true);
    }
}

$('#section-step3-1 input[name="bnpYesno"]').change(function () {
    if ($(this).val() === 'yes') {
        toggleSections('#section-step3-2', '#section-step3-1');
        $('#ntprobnp-input').prop('disabled', true);
        $('#bnp-input').prop('disabled', true);
        toggleInputBasedOnSelection('#section-step3-2', '#ntprobnp-input', 'ntprobnp');
        toggleInputBasedOnSelection('#section-step3-2', '#bnp-input', 'bnp');
        setStepDisabled('step4', false);
    } else if ($(this).val() === 'no') {
        openModal('modal-cmems-more-info');
        setStepDisabled('step4', true);
    } else {
        setStepDisabled('step4', false);
    }
});

$('#section-step3-1').on('click', 'input[name="bnpYesno"][value="yes"]:checked', () => {
    toggleSections('#section-step3-2', '#section-step3-1');
});

$('.o-wizard__btn .o-wizard__btn--back button[name="step3"]').click(() => {
    if ($('#section-step3-1 input[name="bnpYesno"][value="yes"]:checked').val()) {
        toggleSections('#section-step3-2', '#section-step3-1');
    }
});

$('.o-wizard__btn .o-wizard__btn--back button[name="step2"]').click(() => {
    toggleSections('#section-step3-1', '#section-step3-2');
});

$('#section-step3-2 input[name="ntprobnp"]').change(function () {
    if ($(this).val() === 'ntprobnp') {
        $('#bnp-input').prop('disabled', true).val('');
        $('#ntprobnp-input').prop('disabled', false);
    } else if ($(this).val() === 'bnp') {
        $('#bnp-input').prop('disabled', false);
        $('#ntprobnp-input').prop('disabled', true).val('');
    }
});

$('button[name="step4"]').on('click', function () {
    evaluateNTprobnp();
    return false;
});

function evaluateNTprobnp() {
    const ntprobnpValue = Math.round(parseFloat($('#ntprobnp-input').val()));
    const bnpValue = Math.round(parseFloat($('#bnp-input').val()));

    if (ntprobnpValue >= 1000 || bnpValue >= 250) {
        openModal('modal-indic');
    }
}

function evaluateBmiEf() {
    const ntprobnpValue = Math.round(parseFloat($('#ntprobnp-input').val()));
    const bnpValue = Math.round(parseFloat($('#bnp-input').val()));
    const bmi = parseInt($('#bmi-input').val());
    const ef = parseInt($('#ef-input').val());
    if (ef > 0) {
        let datasetKey;

        if (ef > 40) {
            datasetKey = isNaN(bnpValue) ? 'bmi_ntprobnp_ef_gr_40' : 'bmi_bnp_ef_gr_40';
        } else {
            datasetKey = isNaN(bnpValue) ? 'bmi_ntprobnp_ef_lte_40' : 'bmi_bnp_ef_lte_40';
        }
        const threshold = jsonData[datasetKey][bmi];

        bnpValue >= threshold || ntprobnpValue >= threshold ?
            openModal('modal-indic') :
            openModal('modal-non-indic-bnp');

    } else {
        openModal('modal-cmems-more-info');
    }
}

$("#submit").click(function () {
    evaluateBmiEf();
    $(this).prop('disabled', false);
});